# Механизм синхронизации данных

## Как работает синхронизация

### 1. **Офлайн-режим (когда нет интернета)**

Когда пользователь работает офлайн:

#### Создание карточки:
1. Карточка сохраняется в **IndexedDB** с временным ID
2. Действие добавляется в очередь **`pendingActions`** с типом `create`
3. Пользователь видит карточку сразу (из IndexedDB)
4. Появляется сообщение "Карточка добавлена (офлайн)!"

#### Редактирование карточки:
1. Изменения сохраняются в **IndexedDB**
2. Действие добавляется в очередь с типом `update`
3. Пользователь видит изменения сразу

#### Удаление карточки:
1. Карточка удаляется из **IndexedDB**
2. Действие добавляется в очередь с типом `delete`
3. Карточка исчезает из интерфейса

### 2. **Автоматическая синхронизация при подключении**

Когда интернет восстанавливается:

#### Триггеры синхронизации:
1. **При загрузке страницы** - если есть интернет, запускается `syncCards()`
2. **При изменении онлайн-статуса** - слушатель `onOnlineStatusChange` автоматически запускает синхронизацию
3. **При любом действии** - если интернет есть, данные сразу отправляются на сервер

#### Процесс синхронизации:

```
1. Проверка онлайн-статуса
   ↓
2. Получение всех карточек с сервера
   ↓
3. Сохранение карточек в IndexedDB (обновление кеша)
   ↓
4. Получение очереди pendingActions из IndexedDB
   ↓
5. Для каждого действия в очереди:
   - create → POST /api/cards
   - update → PATCH /api/cards/:id
   - delete → DELETE /api/cards/:id
   ↓
6. Если действие успешно → удаление из очереди
   ↓
7. Если ошибка (не сетевая) → удаление из очереди
   ↓
8. Если ошибка (сетевая) → оставление в очереди для следующей попытки
```

### 3. **Структура данных в IndexedDB**

#### Таблица `cards`:
- Все карточки пользователя
- Обновляется при синхронизации с сервера
- Используется для офлайн-работы

#### Таблица `pendingActions`:
```javascript
{
  id: "create-1234567890",
  type: "create" | "update" | "delete",
  data: { /* данные карточки */ },
  timestamp: 1234567890
}
```

### 4. **Примеры работы**

#### Пример 1: Создание карточки офлайн
```
1. Пользователь создает карточку "Кот - Cat" (офлайн)
   → Сохраняется в IndexedDB с ID: 1234567890
   → pendingActions: [{ type: 'create', data: {...}, id: 'create-1234567890' }]

2. Интернет восстановился
   → syncPendingActions() запускается автоматически
   → POST /api/cards с данными карточки
   → Сервер возвращает карточку с реальным ID: 42
   → IndexedDB обновляется: старый ID удаляется, новый ID сохраняется
   → pendingActions очищается

3. Результат: карточка синхронизирована с сервером
```

#### Пример 2: Редактирование карточки офлайн
```
1. Пользователь редактирует карточку ID: 42 (офлайн)
   → IndexedDB обновляется локально
   → pendingActions: [{ type: 'update', data: { id: 42, ... }, id: 'update-42-1234567890' }]

2. Интернет восстановился
   → PATCH /api/cards/42 с новыми данными
   → pendingActions очищается

3. Результат: изменения синхронизированы
```

#### Пример 3: Несколько действий офлайн
```
1. Пользователь создает 3 карточки, редактирует 1, удаляет 1 (офлайн)
   → pendingActions: [
       { type: 'create', ... },
       { type: 'create', ... },
       { type: 'create', ... },
       { type: 'update', ... },
       { type: 'delete', ... }
     ]

2. Интернет восстановился
   → Все действия выполняются последовательно
   → Каждое успешное действие удаляется из очереди
   → Если одно действие не удалось (не сетевая ошибка), оно удаляется
   → Если сетевая ошибка, действие остается для следующей попытки

3. Результат: все действия синхронизированы
```

### 5. **Обработка ошибок**

#### Сетевые ошибки:
- Действие остается в очереди
- Будет повторена попытка при следующей синхронизации

#### Ошибки сервера (400, 500 и т.д.):
- Действие удаляется из очереди
- Пользователь может увидеть ошибку в консоли
- Данные остаются в IndexedDB

#### Конфликты:
- Если карточка была изменена на сервере, локальные изменения могут перезаписать серверные
- В будущем можно добавить разрешение конфликтов

### 6. **Проверка синхронизации**

#### В DevTools:
1. **Application → IndexedDB → CardsAppDB → pendingActions**
   - Показывает все действия, ожидающие синхронизации
   - Должно быть пусто после успешной синхронизации

2. **Console**
   - Логи с префиксом `[SYNC]` показывают процесс синхронизации
   - `[SYNC] Found X pending actions` - найдено действий
   - `[SYNC] Created card: ...` - действие выполнено
   - `[SYNC] Cards synced successfully` - синхронизация завершена

### 7. **Ручная синхронизация**

Синхронизация запускается автоматически, но можно вызвать вручную:

```javascript
import { syncCards } from './lib/offline-sync';

// Принудительная синхронизация
await syncCards();
```

### 8. **Особенности**

- **Автоматическая**: синхронизация запускается при восстановлении интернета
- **Последовательная**: действия выполняются по очереди
- **Надежная**: сетевые ошибки не теряют данные
- **Прозрачная**: пользователь видит все изменения сразу, даже офлайн

# Настройка первичной авторизации через Telegram

## Важно: Telegram Login Widget требует домен

⚠️ **Telegram Login Widget не работает напрямую с IP-адресами.** Для работы с внешним IP (46.191.230.86) вам нужно:

### Вариант 1: Использовать домен (рекомендуется для production)

1. **Настройте DNS запись** для вашего домена, чтобы она указывала на IP 46.191.230.86:
   ```
   A запись: ваш-домен.com → 46.191.230.86
   ```

2. **Настройте домен в BotFather:**
   - Откройте [@BotFather](https://t.me/BotFather) в Telegram
   - Отправьте команду `/setdomain`
   - Выберите вашего бота из списка
   - Введите домен **БЕЗ протокола** (например: `app.yourdomain.com`)
   - ⚠️ Не указывайте `http://` или `https://` - только домен

3. **Обновите переменные окружения:**
   ```bash
   # В docker-compose.yml или .env
   FRONTEND_URL=http://app.yourdomain.com:3003
   NEXT_PUBLIC_API_URL=http://app.yourdomain.com:3002
   ```

### Вариант 2: Использовать ngrok (для тестирования)

Если у вас нет домена, можно использовать ngrok для получения временного домена:

1. **Установите ngrok:**
   ```bash
   # Linux
   wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
   tar -xzf ngrok-v3-stable-linux-amd64.tgz
   sudo mv ngrok /usr/local/bin/
   
   # Или через пакетный менеджер
   sudo apt install ngrok  # Ubuntu/Debian
   ```

2. **Зарегистрируйтесь на ngrok.com** и получите токен

3. **Настройте ngrok:**
   ```bash
   ngrok config add-authtoken ваш_токен_от_ngrok
   ```

4. **Запустите ngrok туннель:**
   ```bash
   ngrok http 3003
   ```

5. **Скопируйте домен** из вывода (например: `abc123.ngrok-free.app`)

6. **Настройте домен в BotFather:**
   - Откройте [@BotFather](https://t.me/BotFather)
   - Отправьте `/setdomain`
   - Выберите вашего бота
   - Введите домен от ngrok (например: `abc123.ngrok-free.app`)

7. **Обновите переменные окружения:**
   ```bash
   FRONTEND_URL=https://abc123.ngrok-free.app
   NEXT_PUBLIC_API_URL=http://46.191.230.86:3002
   ```

⚠️ **Важно:** В бесплатной версии ngrok домен меняется при каждом перезапуске. Вам нужно будет обновлять его в BotFather.

### Вариант 3: Использовать IP с доменом (обходной путь)

Если у вас есть любой домен, можно настроить поддомен:

1. Создайте поддомен в DNS (например: `46-191-230-86.yourdomain.com`)
2. Настройте A-запись на IP 46.191.230.86
3. Настройте этот поддомен в BotFather
4. Используйте этот поддомен для доступа

## Шаг 1: Создание Telegram бота

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям и создайте бота
4. Сохраните полученный токен (например: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)
5. **Запомните имя бота** (без @), например: `S7b0t4bot`

## Шаг 2: Настройка переменных окружения

### Backend

Создайте файл `backend/.env` или добавьте в `docker-compose.yml`:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_от_BotFather
JWT_SECRET=ваш_секретный_ключ_для_jwt_минимум_32_символа
```

### Frontend

В `docker-compose.yml` уже настроено, но можно переопределить:

```env
NEXT_PUBLIC_TELEGRAM_BOT_NAME=S7b0t4bot
NEXT_PUBLIC_API_URL=http://46.191.230.86:3002
```

## Шаг 3: Настройка домена в BotFather

**Это критически важно!** Без этого виджет не будет работать.

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/setdomain`
3. Выберите вашего бота из списка
4. Введите домен **БЕЗ протокола** (например: `app.yourdomain.com` или `abc123.ngrok-free.app`)
5. Подтвердите

⚠️ **Важно:**
- Не указывайте `http://` или `https://`
- Не указывайте порт (например, не `app.yourdomain.com:3003`)
- После изменения может потребоваться несколько минут для применения

## Шаг 4: Запуск приложения

```bash
# Пересоберите контейнеры с новыми переменными
docker-compose down
docker-compose up -d --build
```

## Шаг 5: Проверка работы

1. Откройте ваш сайт (через домен или ngrok)
2. Перейдите на страницу авторизации: `/auth`
3. Вы должны увидеть кнопку "Login with Telegram"
4. Нажмите на неё
5. Подтвердите авторизацию в Telegram
6. Вы автоматически войдете в систему

## Как это работает

1. Пользователь открывает страницу `/auth`
2. Видит кнопку "Login with Telegram" (Telegram Login Widget)
3. Нажимает на кнопку
4. Telegram открывает окно авторизации
5. После подтверждения Telegram возвращает данные пользователя
6. Backend проверяет подлинность данных через криптографический hash
7. Если данные верны - создается новый пользователь (при первом входе) или находится существующий
8. Выдается JWT токен
9. Пользователь автоматически перенаправляется на главную страницу

## Безопасность

- ✅ Все данные проверяются через криптографический hash (HMAC-SHA256)
- ✅ Данные авторизации действительны только 5 минут
- ✅ JWT токен действителен 7 дней
- ✅ При первом входе автоматически создается новый пользователь
- ✅ При повторном входе обновляется имя пользователя из Telegram

## Решение проблем

### Виджет не появляется

- Проверьте, что `NEXT_PUBLIC_TELEGRAM_BOT_NAME` указан правильно (без @)
- Проверьте, что домен настроен в BotFather
- Проверьте консоль браузера на наличие ошибок

### Ошибка "Invalid Telegram authentication data"

- Проверьте, что `TELEGRAM_BOT_TOKEN` указан правильно в backend
- Убедитесь, что токен соответствует боту, имя которого указано в `NEXT_PUBLIC_TELEGRAM_BOT_NAME`

### Ошибка "Authentication data expired"

- Данные авторизации действительны только 5 минут
- Попробуйте авторизоваться снова

### Виджет не работает с IP адресом

- Telegram Login Widget требует домен, а не IP
- Используйте один из вариантов выше (домен, ngrok, или поддомен)

## Для разработки (локально)

Для локальной разработки используйте ngrok или настройте локальный домен через `/etc/hosts`:

```bash
# Добавьте в /etc/hosts
127.0.0.1 localapp.local
```

Затем настройте `localapp.local` в BotFather (но это может не работать, лучше использовать ngrok).

